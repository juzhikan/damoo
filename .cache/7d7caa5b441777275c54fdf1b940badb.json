{"dependencies":[{"name":"babel-runtime/helpers/classCallCheck"},{"name":"babel-runtime/helpers/createClass"},{"name":"../common/utils"}],"generated":{"js":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nvar _classCallCheck2 = require(\"babel-runtime/helpers/classCallCheck\");\n\nvar _classCallCheck3 = _interopRequireDefault(_classCallCheck2);\n\nvar _createClass2 = require(\"babel-runtime/helpers/createClass\");\n\nvar _createClass3 = _interopRequireDefault(_createClass2);\n\nvar _utils = require(\"../common/utils\");\n\nfunction _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }\n\nvar transitionendMap = ['transitionend', 'webkitTransitionEnd', 'oTransitionEnd', 'otransitionend']; /*!\r\n                                                                                                      * Damoo - HTML5 Danmaku Engine v0.0.0\r\n                                                                                                      * https://github.com/juzhikan/Damoo\r\n                                                                                                      *\r\n                                                                                                      * Copyright (c) 2015-2017 juzhikan\r\n                                                                                                      * Released under the MIT license\r\n                                                                                                      */\n\nvar prefixMap = ['', 'webkit', 'moz', 'ms', 'o'];\n\n/* 单位只支持 px */\n\nvar Damoo = function () {\n  function Damoo(options) {\n    (0, _classCallCheck3.default)(this, Damoo);\n\n    var opts = options || {};\n    this.opts = opts;\n    var container = this.container = (0, _utils.getElement)(opts.container);\n    container.style.overflow = 'hidden';\n\n    this.onEnd = opts.onEnd || function () {};\n\n    var fontSize = parseFloat(opts.fontSize || 14);\n    var gap = parseFloat(opts.gap || 2);\n    this.width = parseFloat((0, _utils.getStyle)(container, 'width'));\n    this.height = opts.height || parseFloat((0, _utils.getStyle)(container, 'height')) || container.style.clientHeight;\n\n    this.trackHeight = parseFloat(opts.trackHeight || fontSize + 4);\n\n    var trackNum = Math.floor((this.height + gap) / (this.trackHeight + gap));\n    console.log(trackNum);\n    var trackWidth = this.width;\n    this.pool = new Pool();\n    this.track = new Track(trackNum, trackWidth, this.trackHeight, gap);\n  }\n  /* 公共样式配置，区别于 默认样式 和 字体对象的个性配置 */\n\n\n  (0, _createClass3.default)(Damoo, [{\n    key: \"getPublicConfig\",\n    value: function getPublicConfig() {\n      var opts = this.opts;\n      return (0, _utils.supplement)({\n        transform: \"translate(\" + this.width + \"px, 0px) translateZ(0px)\",\n        lineHeight: opts.lineHeight || this.trackHeight,\n        height: this.trackHeight\n      }, opts);\n    }\n    /* 弹幕装载 */\n\n  }, {\n    key: \"load\",\n    value: function load(bullets) {\n      var publicConfig = this.getPublicConfig();\n      if (!bullets) return;\n      var bulletsArr = Object.prototype.toString.call(bullets) === '[object Array]' ? bullets : [bullets];\n      for (var i = 0; i < bulletsArr.length; i++) {\n        var bullet = bulletsArr[i];\n        var isLiteral = typeof bullet === 'string';\n        if (!isLiteral && !bullet.text) {\n          throw new Error('The text attribute is required！');\n          return;\n        }\n        bullet = isLiteral && { text: bullet } || bullet;\n        bullet = (0, _utils.supplement)(bullet, publicConfig);\n        this.pool.load(new Bullet(bullet));\n      }\n    }\n    /* 弹幕倾泻 */\n\n  }, {\n    key: \"flowOut\",\n    value: function flowOut() {\n      var self = this;\n      var limit = 2;\n      var timer = setInterval(function () {\n        if (!self.pool.getAmount()) {\n          clearInterval(timer);\n          self.onEnd();\n        } else if (self.track.getValidTrackIndex() !== false && limit > 0) {\n          var bullet = self.pool.getLoaded();\n          var bulletDom = document.createElement('div');\n          transitionendMap.forEach(function (key) {\n            bulletDom.addEventListener(key, function (event) {\n              var target = event.currentTarget;\n              target.parentNode.removeChild(target);\n            });\n          });\n\n          for (var key in bullet) {\n            var quote = key === 'innerHTML' || key === 'className' ? bulletDom : bulletDom.style;\n            quote[key] = bullet[key];\n          }\n\n          self.container.appendChild(bulletDom);\n          self.track.addTrack(bulletDom);\n          limit--;\n        } else {\n          clearInterval(timer);\n          setTimeout(function () {\n            self.flowOut();\n          }, 4000);\n        }\n      }, 300);\n    }\n  }]);\n  return Damoo;\n}();\n\nvar Bullet = function Bullet(blt) {\n  (0, _classCallCheck3.default)(this, Bullet);\n\n  this.lineHeight = discernUnit(blt.lineHeight);\n  this.height = discernUnit(blt.height);\n  this.innerHTML = blt.avatar ? \"<div>\" + blt.text + \"</div><img src=\\\"\" + blt.avatar + \"\\\">\" : blt.text;\n  var self = this;\n  prefix(function (prefix) {\n    var suffix = prefix === '' ? 'transform' : 'Transform';\n    self[\"\" + prefix + suffix] = blt.transform;\n  });\n  this.fontWeight = blt.fontWeight || 'bold';\n  this.fontFamily = blt.fontFamily || 'sans-serif';\n  this.textShadow = blt.textShadow || 'none';\n  this.opacity = blt.opacity || 1;\n  this.color = blt.color || 'rgb(255, 255, 255)';\n  this.backgroundColor = blt.backgroundColor || 'transparent';\n  this.fontSize = discernUnit(blt.fontSize || 14);\n  this.borderRadius = discernUnit(blt.borderRadius || 0);\n  /* 固定配置 */\n  this.display = 'inline-block';\n  this.whiteSpace = 'pre';\n  this.position = 'absolute';\n  (0, _utils.supplement)(this, blt);\n};\n\nfunction discernUnit(value) {\n  if (typeof value === 'number' && value !== 0) {\n    return value + \"px\";\n  }\n  return value;\n}\n\n/* 获取子弹剩余距离，计算时间，避免碰撞 */\nfunction getDistance(blt) {\n  var transform = (0, _utils.getStyle)(blt, 'transform') || (0, _utils.getStyle)(blt, 'webkitTransform');\n  if (transform === undefined || transform === '') return undefined;\n  var translatex = transform.replace('matrix(', '').replace(')', '').split(',')[4].replace(/^[\\s\\uFEFF\\xA0]+|[\\s\\uFEFF\\xA0]+$/g, '');\n  return parseFloat(translatex) + blt.clientWidth;\n}\n\nvar Track = function () {\n  function Track(n, w, h, g) {\n    (0, _classCallCheck3.default)(this, Track);\n\n    this.num = n;\n    this.width = w;\n    this.height = h;\n    this.gap = g;\n    this.records = [];\n    while (n--) {\n      this.records.push({\n        node: null,\n        duration: 0\n      });\n    }\n  }\n  /* 获取可用的弹轨，无可用返回 false */\n\n\n  (0, _createClass3.default)(Track, [{\n    key: \"getValidTrackIndex\",\n    value: function getValidTrackIndex() {\n      var records = this.records;\n      for (var index = 0; index < records.length; index++) {\n        var record = records[index];\n        if (record.node && getDistance(record.node) === undefined) {\n          record.node = null;\n          return index;\n        } else if (!record.node || getDistance(record.node) < this.width) {\n          return index;\n        }\n      }\n      return false;\n    }\n    /* 将弹幕加入弹轨，随后发射弹幕 */\n\n  }, {\n    key: \"addTrack\",\n    value: function addTrack(bullet, index) {\n      var trackIndex = index !== undefined ? index : (0, _utils.getRandom)(0, this.num - 1);\n      trackIndex = trackIndex || 0;\n      var top = trackIndex * (this.height + this.gap);\n      /* 弹幕是否能放到当前轨道中，不能的话另寻轨道，能的话计算速度 */\n      var record = this.records[trackIndex];\n      if (record.node) {\n        var nearestBullet = record.node;\n        var duration = record.duration;\n        var distance = getDistance(nearestBullet);\n        if (distance > this.width) {\n          var validTrackIndex = this.getValidTrackIndex();\n          this.addTrack(bullet, validTrackIndex);\n          return;\n        } else if (distance >= 0) {\n          /* 可以放入，需要计算时间 */\n          var w = this.width;\n          var bullet_speed = (w + nearestBullet.clientWidth) / duration * w / distance;\n          var bullet_duration = (bullet.clientWidth + w + 10) / bullet_speed;\n          bullet_duration = bullet_duration < 4 ? 4 : bullet_duration;\n          this.shoot(bullet, bullet_duration, trackIndex, top);\n          return;\n        }\n      }\n      this.shoot(bullet, 6, trackIndex, top);\n    }\n    /* 发射弹幕 */\n\n  }, {\n    key: \"shoot\",\n    value: function shoot(bullet, duration, trackIndex, top) {\n      this.records[trackIndex].node = bullet;\n      this.records[trackIndex].duration = duration;\n\n      prefix(function (prefix) {\n        var suffix = prefix === '' ? 'transition' : 'Transition';\n        bullet.style[\"\" + prefix + suffix] = \"-\" + prefix + \"-transform \" + duration + \"s linear\";\n      });\n\n      bullet.style.top = top + 'px';\n      requestAnimationFrame(function () {\n        setTransform(bullet, -bullet.clientWidth);\n      });\n    }\n  }]);\n  return Track;\n}();\n\nfunction prefix(callback) {\n  prefixMap.forEach(function (prefix) {\n    callback(prefix);\n  });\n}\n\nfunction setTransform(node, x, y, z) {\n  prefix(function (prefix) {\n    var suffix = prefix === '' ? 'transform' : 'Transform';\n    node.style[\"\" + prefix + suffix] = \"translate(\" + (x || 0) + \"px, \" + (y || 0) + \"px) translateZ(\" + (z || 0) + \"px)\";\n  });\n}\n\nvar Pool = function () {\n  function Pool() {\n    (0, _classCallCheck3.default)(this, Pool);\n\n    this.bullets = [];\n  }\n\n  (0, _createClass3.default)(Pool, [{\n    key: \"load\",\n    value: function load(bullet) {\n      this.bullets.push(bullet);\n    }\n  }, {\n    key: \"getLoaded\",\n    value: function getLoaded() {\n      return this.bullets.length && this.bullets.shift();\n    }\n  }, {\n    key: \"getAmount\",\n    value: function getAmount() {\n      return this.bullets.length;\n    }\n  }, {\n    key: \"empty\",\n    value: function empty() {\n      this.bullets = [];\n    }\n  }]);\n  return Pool;\n}();\n\nexports.default = Damoo;"},"hash":"5820c9c683fb41aac84edf404a34a597"}